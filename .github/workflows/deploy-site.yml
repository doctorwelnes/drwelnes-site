name: Deploy Dr.Welnes to VPS

on:
  push:
    branches: ["master", "main"]
    paths-ignore:
      - "site/**"
      - "README.md"
      - ".vscode/**"
  workflow_dispatch:

concurrency:
  group: deploy-drwelnes
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: [self-hosted, linux, x64, vps]

    env:
      COMPOSE_FILE: /var/www/drwelnes/docker-compose.prod.yml
      APP_DIR: /var/www/drwelnes

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Skip if already deployed
        id: check_skip
        run: |
          set -euo pipefail
          DEPLOYED_SHA_FILE="${{ env.APP_DIR }}/.deployed_sha"
          if [ -f "$DEPLOYED_SHA_FILE" ]; then
            deployed=$(cat "$DEPLOYED_SHA_FILE")
            if [ "$deployed" = "${{ github.sha }}" ]; then
              echo "Already deployed commit ${{ github.sha }}; skipping."
              echo "skip=true" >> "$GITHUB_OUTPUT"
            else
              echo "skip=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Copy source to app dir
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          set -euo pipefail
          mkdir -p "${{ env.APP_DIR }}"
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='site' \
            --exclude='node_modules' \
            ./ "${{ env.APP_DIR }}/src/"

      - name: Copy production env file
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          set -euo pipefail
          # .env.production must exist on the VPS at $APP_DIR/.env.production
          if [ ! -f "${{ env.APP_DIR }}/.env.production" ]; then
            echo "ERROR: ${{ env.APP_DIR }}/.env.production not found on VPS"
            exit 1
          fi
          cp "${{ env.APP_DIR }}/.env.production" "${{ env.APP_DIR }}/src/.env.production"

      - name: Build and deploy Docker containers
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          set -euo pipefail
          cd "${{ env.APP_DIR }}/src"
          docker compose -f docker-compose.prod.yml build --no-cache
          docker compose -f docker-compose.prod.yml up -d --remove-orphans

      - name: Run database migrations
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          set -euo pipefail
          cd "${{ env.APP_DIR }}/src"
          # Wait for DB to be healthy, then run migrations
          docker compose -f docker-compose.prod.yml exec -T web \
            npx prisma migrate deploy || true

      - name: Save deployed SHA
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          echo "${{ github.sha }}" > "${{ env.APP_DIR }}/.deployed_sha"

      - name: Healthcheck
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          set -euo pipefail

          BASE_URL="https://drwelnes.ru"
          MAX_ATTEMPTS=30
          SLEEP_SECONDS=3

          check_url() {
            local name="$1"
            local url="$2"
            local expect_code="$3"

            echo "==> Checking ${name}: ${url} (expect ${expect_code})"
            local attempt=1
            while [ "$attempt" -le "$MAX_ATTEMPTS" ]; do
              http_code=$(curl -sS -L --max-time 15 -o /dev/null -w "%{http_code}" "$url" || echo "000")
              if [ "$http_code" = "$expect_code" ]; then
                echo "OK: ${name}"
                return 0
              else
                echo "Attempt ${attempt}/${MAX_ATTEMPTS}: got HTTP ${http_code}, expected ${expect_code}"
              fi
              attempt=$((attempt + 1))
              sleep "$SLEEP_SECONDS"
            done
            echo "FAIL: ${name} healthcheck did not pass"
            return 1
          }

          check_url "Home" "${BASE_URL}/" "200"
          check_url "Login" "${BASE_URL}/login" "200"

      - name: Cleanup old Docker images
        if: always()
        run: docker image prune -f

      - name: Notify Telegram on failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -euo pipefail
          if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
            echo "Telegram secrets not configured; skipping."
            exit 0
          fi
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT="❌ Deploy failed\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}\nRun: ${RUN_URL}"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "disable_web_page_preview=true" \
            >/dev/null

      - name: Notify Telegram on success
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -euo pipefail
          if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
            echo "Telegram secrets not configured; skipping."
            exit 0
          fi
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT="✅ Deploy succeeded\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}\nRun: ${RUN_URL}"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "disable_web_page_preview=true" \
            >/dev/null
