name: Deploy Astro Site to VPS

on:
  push:
    branches: [ "master", "main" ]
    paths:
      - "site/**"
      - ".github/workflows/deploy-site.yml"
  workflow_dispatch:

concurrency:
  group: deploy-site
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: [self-hosted, linux, x64, vps]

    env:
      BASE_DIR: /var/www/drwelnes-site
      RELEASE_NAME: release-${{ github.run_number }}-${{ github.sha }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Install dependencies
        run: |
          cd site
          npm ci

      - name: Build Astro site
        run: |
          cd site
          npm run build

      - name: Prepare release directory
        run: |
          RELEASE_DIR="${{ env.BASE_DIR }}/releases/${{ env.RELEASE_NAME }}"
          mkdir -p "$RELEASE_DIR"

      - name: Sync built files to release
        run: |
          RELEASE_DIR="${{ env.BASE_DIR }}/releases/${{ env.RELEASE_NAME }}"
          rsync -avz --delete site/dist/ "$RELEASE_DIR/"

      - name: Sync shared directories
        run: |
          RELEASE_DIR="${{ env.BASE_DIR }}/releases/${{ env.RELEASE_NAME }}"
          CURRENT_LINK="${{ env.BASE_DIR }}/current"
          # Sync public uploads and other shared directories
          if [ -d "$CURRENT_LINK/public/uploads" ]; then
            rsync -avz "$CURRENT_LINK/public/uploads/" "$RELEASE_DIR/public/uploads/"
          fi

      - name: Switch release
        run: |
          RELEASE_DIR="${{ env.BASE_DIR }}/releases/${{ env.RELEASE_NAME }}"
          CURRENT_LINK="${{ env.BASE_DIR }}/current"
          PREV_LINK="${{ env.BASE_DIR }}/previous"
          # Update previous link
          if [ -L "$PREV_LINK" ]; then
            rm "$PREV_LINK"
          fi
          if [ -L "$CURRENT_LINK" ]; then
            mv "$CURRENT_LINK" "$PREV_LINK"
          fi

          # Create new current link
          ln -s "$RELEASE_DIR" "$CURRENT_LINK"

      - name: Cleanup old releases
        run: |
          cd "${{ env.BASE_DIR }}/releases"
          ls -t | tail -n +6 | xargs -r rm -rf

      - name: Healthcheck
        run: |
          set -euo pipefail

          BASE_URL="https://drwelnes.ru"

          # Retries are important because nginx reloads / file sync can create a short window
          # where the site responds with transient errors.
          MAX_ATTEMPTS=20
          SLEEP_SECONDS=2

          check_url() {
            local name="$1"
            local url="$2"
            local expect_code="$3"

            echo "==> Checking ${name}: ${url} (expect ${expect_code})"

            local attempt=1
            while [ "$attempt" -le "$MAX_ATTEMPTS" ]; do
              # Get HTTP code separately from body
              http_code=$(curl -sS -L --max-time 15 -o /dev/null -w "%{http_code}" "$url" || echo "000")

              if [ "$http_code" = "$expect_code" ]; then
                echo "OK: ${name}"
                return 0
              else
                echo "Attempt ${attempt}/${MAX_ATTEMPTS}: got HTTP ${http_code}, expected ${expect_code}"
              fi

              attempt=$((attempt + 1))
              sleep "$SLEEP_SECONDS"
            done

            echo "FAIL: ${name} healthcheck did not pass"
            return 1
          }

          check_url "Home" "${BASE_URL}/" "200"
          check_url "Admin" "${BASE_URL}/admin/" "200"
          check_url "Decap config" "${BASE_URL}/admin/config.yml" "200"
          check_url "OAuth health" "${BASE_URL}/api/auth/health" "200"

      - name: Notify Telegram on failure
        if: ${{ failure() }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -euo pipefail

          if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
            echo "Telegram secrets are not configured; skipping notification."
            exit 0
          fi

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT="âŒ Deploy failed\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}\nRun: ${RUN_URL}"

          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "disable_web_page_preview=true" \
            >/dev/null
