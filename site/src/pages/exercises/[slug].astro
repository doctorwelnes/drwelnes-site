---
import { getCollection } from "astro:content";
import { toEmbedUrl } from "../../lib/video";

export async function getStaticPaths() {
  const items = await getCollection("exercises");
  return items.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
---

<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{entry.data.title}</title>
  </head>
  <body>
    <main style="min-height: 100vh; background: radial-gradient(1200px 600px at 20% -10%, #dbeafe 0%, rgba(219,234,254,0) 55%), radial-gradient(900px 520px at 90% 0%, #fce7f3 0%, rgba(252,231,243,0) 55%), #ffffff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">
      <div style="max-width: 980px; margin: 0 auto; padding: 28px 20px 36px;">
        <header style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 18px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <img src="/logo.png" alt="Dr.Welnes" width="34" height="34" style="display:block; width:34px; height:34px; border-radius: 10px; object-fit: cover;" />
            <div style="font-weight: 700; letter-spacing: -0.01em;">Dr.Welnes</div>
          </div>
          <nav style="display: flex; flex-wrap: wrap; gap: 10px;">
            <a href="/recipes" style="text-decoration: none; color: #111827; padding: 8px 10px; border-radius: 10px;">–†–µ—Ü–µ–ø—Ç—ã</a>
            <a href="/exercises" style="text-decoration: none; color: #111827; padding: 8px 10px; border-radius: 10px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</a>
            <a href="/theory" style="text-decoration: none; color: #111827; padding: 8px 10px; border-radius: 10px;">–¢–µ–æ—Ä–∏—è</a>
            <a href="/calculators" style="text-decoration: none; color: #111827; padding: 8px 10px; border-radius: 10px;">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã</a>
          </nav>
        </header>

        <section style="border: 1px solid rgba(229,231,235,.9); background: rgba(255,255,255,.8); backdrop-filter: blur(10px); border-radius: 18px; padding: 22px; box-shadow: 0 10px 30px rgba(15,23,42,.08);">
          <h1 style="margin: 0 0 8px; font-size: 28px; line-height: 1.15; letter-spacing: -0.03em;">{entry.data.title}</h1>
          {entry.data.description && (
            <p style="margin: 0; color: #4b5563;">{entry.data.description}</p>
          )}
        </section>

      {entry.data.videoFile ? (
        <div style="margin: 16px 0;">
          <div data-video-shell style="border-radius: 12px; overflow: hidden; background: #000; box-shadow: 0 10px 30px rgba(15,23,42,.10); position: relative;">
            <div
              data-video-backdrop
              aria-hidden="true"
              style="display:none; position:absolute; inset:0; background-position:center; background-size:cover; filter: blur(18px); transform: scale(1.08); opacity:.55;"
            ></div>
            <video
              controls={false}
              playsinline
              preload="metadata"
              controlslist="nodownload"
              style="display:block; width: 100%; height: auto; max-height: 75vh; background: #000; position: relative; z-index: 1;"
              src={entry.data.videoFile}
              poster={entry.data.videoPoster}
              data-video-resume-key={`exercise:${entry.slug}`}
            />
            
            <!-- Custom controls -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; z-index: 3; pointer-events: auto; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 12px; display: flex; align-items: center; gap: 10px;">
              <button
                type="button"
                data-video-play-pause
                style="background: none; border: none; color: white; cursor: pointer; font-size: 18px; padding: 4px;"
              >
                ‚ñ∂
              </button>
              
              <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; position: relative; cursor: pointer;" data-video-progress>
                <div data-video-progress-bar style="height: 100%; background: #ef4444; border-radius: 2px; width: 0%; transition: width 0.1s;"></div>
              </div>
              
              <span data-video-time style="color: white; font-size: 12px; min-width: 80px;">0:00 / 0:00</span>
              
              <button
                type="button"
                data-video-mute
                style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; padding: 4px;"
              >
                üîä
              </button>
              
              <select
                data-video-speed
                style="background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 4px; border-radius: 4px; font-size: 12px; cursor: pointer;"
              >
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
              </select>
              
              <button
                type="button"
                data-video-fullscreen
                style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; padding: 4px;"
              >
                ‚õ∂
              </button>
            </div>
          </div>

          </div>
        </div>
      ) : (
        entry.data.videoUrl && (
          <div style="margin: 16px 0;">
            <iframe
              width="100%"
              height="420"
              src={toEmbedUrl(entry.data.videoUrl)}
              title={entry.data.title}
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
              style="border: 0; border-radius: 12px;"
            />
          </div>
        )
      )}

        <article style="line-height: 1.6; background: rgba(255,255,255,.85); border: 1px solid rgba(229,231,235,.9); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(15,23,42,.06);">
          <Content />
        </article>
      </div>
    </main>

    <script>
      (() => {
        const video = document.querySelector('video[data-video-resume-key]');
        if (!video) return;

        const shell = video.closest('[data-video-shell]');
        const backdrop = shell ? shell.querySelector('[data-video-backdrop]') : null;
        
        // Custom controls elements
        const playPauseBtn = shell?.querySelector('[data-video-play-pause]');
        const progressBar = shell?.querySelector('[data-video-progress]');
        const progressBarFill = shell?.querySelector('[data-video-progress-bar]');
        const timeDisplay = shell?.querySelector('[data-video-time]');
        const muteBtn = shell?.querySelector('[data-video-mute]');
        const speedSelect = shell?.querySelector('[data-video-speed]');
        const fullscreenBtn = shell?.querySelector('[data-video-fullscreen]');

        const key = video.getAttribute('data-video-resume-key');
        if (!key) return;

        const tKey = `drw:video:time:${key}`;
        const rKey = `drw:video:rate:${key}`;

        const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
        
        const formatTime = (seconds) => {
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}:${secs.toString().padStart(2, '0')}`;
        };
        
        const updatePlayPauseButton = () => {
          if (playPauseBtn) {
            playPauseBtn.textContent = video.paused ? '‚ñ∂' : '‚ùö‚ùö';
          }
        };
        
        const updateProgress = () => {
          if (progressBarFill && timeDisplay) {
            const percent = (video.currentTime / video.duration) * 100;
            progressBarFill.style.width = `${percent}%`;
            timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
          }
        };
        
        const updateMuteButton = () => {
          if (muteBtn) {
            muteBtn.textContent = video.muted ? 'üîá' : 'üîä';
          }
        };

        const readNumber = (k) => {
          try {
            const raw = localStorage.getItem(k);
            if (!raw) return null;
            const n = Number(raw);
            return Number.isFinite(n) ? n : null;
          } catch {
            return null;
          }
        };

        const writeNumber = (k, v) => {
          try {
            localStorage.setItem(k, String(v));
          } catch {
            // ignore
          }
        };

        const savedRate = readNumber(rKey);
        if (savedRate && speedSelect) {
          video.playbackRate = clamp(savedRate, 0.25, 4);
          speedSelect.value = String(savedRate);
        }

        const applySavedTime = () => {
          const saved = readNumber(tKey);
          if (!saved || !Number.isFinite(video.duration) || video.duration <= 0) return;
          const target = clamp(saved, 0, Math.max(0, video.duration - 1));
          if (target > 0) video.currentTime = target;
        };

        const applyOrientation = () => {
          const vw = video.videoWidth;
          const vh = video.videoHeight;
          if (!vw || !vh) return;

          const portrait = vh > vw;

          if (shell) {
            if (portrait) {
              shell.style.maxWidth = '460px';
              shell.style.margin = '0 auto';
            } else {
              shell.style.maxWidth = '';
              shell.style.margin = '';
            }
          }

          const poster = video.getAttribute('poster');
          if (backdrop && poster && portrait) {
            backdrop.style.backgroundImage = `url("${poster}")`;
            backdrop.style.display = 'block';
          } else if (backdrop) {
            backdrop.style.display = portrait ? 'block' : 'none';
            if (!poster) backdrop.style.backgroundImage = '';
          }
        };

        const setBackdropFromVideoFrame = () => {
          if (!backdrop) return;
          const poster = video.getAttribute('poster');
          if (poster) return;

          const vw = video.videoWidth;
          const vh = video.videoHeight;
          if (!vw || !vh) return;
          if (!(vh > vw)) return;

          try {
            const canvas = document.createElement('canvas');
            canvas.width = Math.max(1, Math.min(vw, 640));
            canvas.height = Math.max(1, Math.round((canvas.width * vh) / vw));

            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataUrl = canvas.toDataURL('image/jpeg', 0.75);
            backdrop.style.backgroundImage = `url("${dataUrl}")`;
            backdrop.style.display = 'block';
          } catch {
            // ignore
          }
        };

        video.addEventListener('loadedmetadata', () => {
          applySavedTime();
          applyOrientation();

          if (video.readyState >= 2) {
            setBackdropFromVideoFrame();
          }
        });

        video.addEventListener('loadeddata', () => {
          setBackdropFromVideoFrame();
          updateProgress();
          updatePlayPauseButton();
          updateMuteButton();
        });
        
        // Custom controls event listeners
        if (playPauseBtn) {
          playPauseBtn.addEventListener('click', () => {
            if (video.paused) {
              video.play().catch(() => null);
            } else {
              video.pause();
            }
          });
        }
        
        if (progressBar) {
          progressBar.addEventListener('click', (e) => {
            const rect = progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            if (video.duration) {
              video.currentTime = percent * video.duration;
              saveTime();
            }
          });
        }
        
        if (muteBtn) {
          muteBtn.addEventListener('click', () => {
            video.muted = !video.muted;
          });
        }
        
        if (speedSelect) {
          speedSelect.addEventListener('change', () => {
            const rate = Number(speedSelect.value);
            if (Number.isFinite(rate)) {
              video.playbackRate = clamp(rate, 0.25, 4);
              saveRate();
            }
          });
        }
        
        if (fullscreenBtn) {
          fullscreenBtn.addEventListener('click', () => {
            if (document.fullscreenElement) {
              document.exitFullscreen?.().catch?.(() => null);
            } else {
              shell?.requestFullscreen?.().catch?.(() => null);
            }
          });
        }
        
        // Video event listeners for custom controls
        video.addEventListener('play', updatePlayPauseButton);
        video.addEventListener('pause', updatePlayPauseButton);
        video.addEventListener('timeupdate', updateProgress);
        video.addEventListener('loadedmetadata', () => {
          updateProgress();
          updateMuteButton();
        });
        video.addEventListener('volumechange', updateMuteButton);

        video.addEventListener('seeked', () => {
          setBackdropFromVideoFrame();
        });

        const saveTime = () => {
          if (!Number.isFinite(video.currentTime)) return;
          writeNumber(tKey, Math.floor(video.currentTime));
        };

        const saveRate = () => {
          writeNumber(rKey, video.playbackRate);
        };

        const interval = window.setInterval(saveTime, 2000);
        video.addEventListener('pause', saveTime);
        video.addEventListener('ended', () => writeNumber(tKey, 0));
        video.addEventListener('ratechange', saveRate);
        window.addEventListener('beforeunload', saveTime);

        const cleanup = () => {
          window.clearInterval(interval);
        };
        window.addEventListener('pagehide', cleanup);

        const isEditableTarget = (t) => {
          if (!t) return false;
          const el = t;
          const tag = (el.tagName || '').toLowerCase();
          return tag === 'input' || tag === 'textarea' || tag === 'select' || el.isContentEditable;
        };

        document.addEventListener('keydown', (e) => {
          if (e.defaultPrevented) return;
          if (isEditableTarget(e.target)) return;
          if (e.ctrlKey || e.metaKey || e.altKey) return;

          const k = e.key;

          if (k === ' ' || k === 'Spacebar') {
            e.preventDefault();
            if (video.paused) video.play().catch(() => null);
            else video.pause();
            return;
          }

          if (k === 'ArrowLeft') {
            e.preventDefault();
            video.currentTime = clamp(video.currentTime - 5, 0, Number.isFinite(video.duration) ? video.duration : video.currentTime);
            saveTime();
            return;
          }

          if (k === 'ArrowRight') {
            e.preventDefault();
            const max = Number.isFinite(video.duration) ? video.duration : video.currentTime + 5;
            video.currentTime = clamp(video.currentTime + 5, 0, max);
            saveTime();
            return;
          }

          if (k === 'm' || k === 'M') {
            e.preventDefault();
            video.muted = !video.muted;
            return;
          }

          if (k === 'f' || k === 'F') {
            e.preventDefault();
            const el = video.parentElement || video;
            if (document.fullscreenElement) {
              document.exitFullscreen?.().catch?.(() => null);
              return;
            }
            el.requestFullscreen?.().catch?.(() => null);
            return;
          }

          const rateByKey = {
            '0': 0.75,
            '1': 1,
            '2': 1.25,
            '3': 1.5,
            '4': 2,
          };
          if (k in rateByKey) {
            e.preventDefault();
            const nextRate = rateByKey[k];
            video.playbackRate = clamp(nextRate, 0.25, 4);
            saveRate();
          }
        });
      })();
    </script>
  </body>
</html>
