---
export type HeaderLink = { href: string; label: string };

const pathname = Astro.url?.pathname ?? "/";

function normPath(p: string) {
  try {
    if (!p) return "/";
    return p.length > 1 ? p.replace(/\/$/, "") : p;
  } catch {
    return p;
  }
}

const current = normPath(pathname);

function isActive(href: string) {
  const h = normPath(href);
  if (h === "/") return current === "/";
  return current === h || current.startsWith(h + "/");
}

const {
  links = [
    { href: "/", label: "Главная" },
    { href: "/recipes", label: "Рецепты" },
    { href: "/exercises", label: "Упражнения" },
    { href: "/theory", label: "Теория" },
    { href: "/calculators", label: "Калькуляторы" },
  ],
} = Astro.props as {
  links?: HeaderLink[];
};
---

<header class="dw-header" data-dw-header>
  <div class="dw-brand">
    <img src="/logo.png" alt="Dr.Welnes" width="34" height="34" class="dw-logo" />
    <div class="dw-brand-name">Dr.Welnes</div>
  </div>

  <nav class="dw-nav" aria-label="Навигация">
    {links.map((l) => {
      const active = isActive(l.href);
      return (
        <a
          href={l.href}
          class={`dw-nav-link${active ? " is-active" : ""}`}
          aria-current={active ? "page" : undefined}
        >
          {l.label}
        </a>
      );
    })}
  </nav>

  <button type="button" class="dw-menu-btn" aria-label="Меню" aria-expanded="false" data-dw-menu-btn>☰</button>

  <div class="dw-mobile-menu" aria-label="Меню">
    {links.map((l) => {
      const active = isActive(l.href);
      return (
        <a
          href={l.href}
          class={active ? "is-active" : undefined}
          aria-current={active ? "page" : undefined}
        >
          {l.label}
        </a>
      );
    })}
  </div>
</header>

<script is:inline>
  (function () {
    try {
      var root = document.querySelector('[data-dw-header]');
      if (!root) return;
      var btn = root.querySelector('.dw-menu-btn');
      var menu = root.querySelector('.dw-mobile-menu');
      if (!btn || !menu) return;

      function isOpen() {
        return menu.classList.contains('is-open');
      }

      var scrollY = 0;
      var bodyLocked = false;

      function lockBodyScroll() {
        try {
          if (bodyLocked) return;
          var body = document.body;
          if (!body) return;
          scrollY = window.scrollY || window.pageYOffset || 0;
          body.style.position = 'fixed';
          body.style.top = '-' + scrollY + 'px';
          body.style.left = '0';
          body.style.right = '0';
          body.style.width = '100%';
          bodyLocked = true;
        } catch (e) {}
      }

      function unlockBodyScroll() {
        try {
          if (!bodyLocked) return;
          var body = document.body;
          if (!body) return;
          body.style.position = '';
          body.style.top = '';
          body.style.left = '';
          body.style.right = '';
          body.style.width = '';
          window.scrollTo(0, scrollY || 0);
          bodyLocked = false;
        } catch (e) {}
      }

      function closeMenu() {
        menu.classList.remove('is-open');
        btn.classList.remove('is-open');
        btn.setAttribute('aria-expanded', 'false');
        btn.textContent = '☰';
        unlockBodyScroll();
      }

      function toggleMenu() {
        var next = !isOpen();
        if (next) {
          menu.classList.add('is-open');
          btn.classList.add('is-open');
          btn.setAttribute('aria-expanded', 'true');
          btn.textContent = '✕';
          lockBodyScroll();
        } else {
          closeMenu();
        }
      }

      btn.addEventListener('click', function (e) {
        try {
          e && e.stopPropagation && e.stopPropagation();
        } catch (e) {}
        toggleMenu();
      });

      document.addEventListener('click', function (e) {
        try {
          var t = e && e.target;
          if (t === btn || (btn.contains && btn.contains(t))) return;
          if (t === menu || (menu.contains && menu.contains(t))) return;
          closeMenu();
        } catch (e) {}
      });

      menu.addEventListener('click', function (e) {
        try {
          var t = e && e.target;
          if (!t) return;
          if (t.tagName && String(t.tagName).toLowerCase() === 'a') {
            closeMenu();
          }
        } catch (e) {}
      });

      document.addEventListener('keydown', function (e) {
        try {
          if (!isOpen()) return;
          var k = e && (e.key || e.code);
          if (k === 'Escape' || k === 'Esc') {
            closeMenu();
            btn && btn.focus && btn.focus();
          }
        } catch (e) {}
      });

      window.addEventListener(
        'scroll',
        function () {
          try {
            if (!isOpen()) return;
            closeMenu();
          } catch (e) {}
        },
        { passive: true }
      );

      window.addEventListener(
        'resize',
        function () {
          try {
            if (!isOpen()) return;
            closeMenu();
          } catch (e) {}
        },
        { passive: true }
      );

      window.addEventListener('hashchange', function () {
        closeMenu();
      });
    } catch (e) {}
  })();
</script>
